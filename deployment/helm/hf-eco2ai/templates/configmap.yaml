apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "hf-eco2ai.fullname" . }}-config
  labels:
    {{- include "hf-eco2ai.labels" . | nindent 4 }}
data:
  config.yaml: |
    environment: {{ .Values.config.environment }}
    logLevel: {{ .Values.config.logLevel }}
    debug: {{ .Values.config.debug }}
    
    monitoring:
      enabled: {{ .Values.monitoring.enabled }}
      prometheusPort: {{ .Values.config.monitoring.prometheusPort }}
      healthCheckPath: {{ .Values.config.monitoring.healthCheckPath }}
      readinessPath: {{ .Values.config.monitoring.readinessPath }}
      livenessPath: {{ .Values.config.monitoring.livenessPath }}
    
    carbonTracking:
      gridCarbonIntensity: {{ .Values.config.carbonTracking.gridCarbonIntensity }}
      realTimeUpdates: {{ .Values.config.carbonTracking.realTimeUpdates }}
      batchSize: {{ .Values.config.carbonTracking.batchSize }}
      flushInterval: {{ .Values.config.carbonTracking.flushInterval }}
    
    security:
      enableTLS: {{ .Values.config.security.enableTLS }}
      certificateSecret: {{ .Values.config.security.certificateSecret }}
      authenticationEnabled: {{ .Values.config.security.authenticationEnabled }}
    
    performance:
      maxConcurrentRequests: {{ .Values.config.performance.maxConcurrentRequests }}
      requestTimeout: {{ .Values.config.performance.requestTimeout }}
      enableCaching: {{ .Values.config.performance.enableCaching }}
      cacheSize: {{ .Values.config.performance.cacheSize }}
    
    features:
      quantumOptimization: {{ .Values.config.features.quantumOptimization }}
      distributedProcessing: {{ .Values.config.features.distributedProcessing }}
      enterpriseHub: {{ .Values.config.features.enterpriseHub }}
      advancedAnalytics: {{ .Values.config.features.advancedAnalytics }}
    
    {{- if .Values.redis.enabled }}
    redis:
      host: {{ include "hf-eco2ai.fullname" . }}-redis
      port: 6379
      {{- if .Values.redis.auth.enabled }}
      auth: true
      {{- end }}
    {{- end }}
    
    {{- if .Values.postgresql.enabled }}
    database:
      host: {{ include "hf-eco2ai.fullname" . }}-postgresql
      port: 5432
      database: {{ .Values.postgresql.auth.database }}
      username: {{ .Values.postgresql.auth.username }}
    {{- end }}

  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s

    rule_files: []

    scrape_configs:
      - job_name: 'hf-eco2ai'
        static_configs:
          - targets: ['localhost:{{ .Values.config.monitoring.prometheusPort }}']
        metrics_path: /metrics
        scrape_interval: 15s

  alerts.yml: |
    groups:
      - name: hf-eco2ai-alerts
        rules:
          - alert: HighCarbonEmissions
            expr: carbon_emissions_rate > 1000
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High carbon emissions detected"
              description: "Carbon emissions rate is {{ $value }} g CO2/hour"
          
          - alert: HighMemoryUsage
            expr: (container_memory_usage_bytes / container_spec_memory_limit_bytes) > 0.8
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High memory usage"
              description: "Memory usage is above 80%"
          
          - alert: ServiceDown
            expr: up == 0
            for: 1m
            labels:
              severity: critical
            annotations:
              summary: "Service is down"
              description: "HF Eco2AI service is not responding"